# Two-Layer CTMC Epidemic Simulators

Event-driven SIR/SIS simulators for two-layer (community + inter-community) contact networks. The repo provides an engine-only Python module plus runner scripts and plotting utilities.

## What's here
- `two_layer_ctmc/` – engine module plus in-memory simulation helpers.
- `two_layer_ctmc/network.py` – packaged two-scale network generator for pip users.
- `two_layer_ctmc/simulate.py` – simulation-first helpers (no CSV output or plotting).
- `network.py` – repo-level network generator used by CSV scripts.
- `Micro_simulator.py` – runner for microscopic Gillespie SIR/SIS with uniform time sampling (CSV output).
- `micromacro2.py` – runner for micro/macro v2 (CSV output).
- `micro_simulation.py` – micro runner logic (used by `Micro_simulator.py`).
- `micromacro_simulation.py` – micro/macro runner logic (used by `micromacro2.py`).
- `visualization.py` – aggregates CSV outputs and plots per-community and aggregated I(t) curves.
- `config.json` – shared parameters for network structure, disease rates, run counts, and output folders.
- `data/` – default output roots for simulators; `plots/` – figures generated by `visualization.py`.

## Quick start
- Python 3.10+ recommended.
- (Optional) Windows venv: `python -m venv .venv && .\.venv\Scripts\activate`
- (Optional) Linux/macOS venv: `python -m venv .venv && source .venv/bin/activate`
- Install from PyPI: `pip install two-layer-ctmc`
- Install from source: `pip install -e .`
- Install deps for CSV runners/plots only: `pip install -r requirements.txt`

## Simulation-first usage (in-memory)
Use the package directly without CSV output or plotting:

```python
from two_layer_ctmc import build_two_layer_network, simulate_micro

net = build_two_layer_network(n_communities=3, community_size=40, inter_links=2, seed=7)
result = simulate_micro(
    network=net,
    beta=0.2,
    gamma=0.1,
    T_end=50.0,
    dt_out=1.0,
    model="SIR",
    seed=123,
)
```

## Batch runs (CSV output)
Use the config file format already in the repo, or call the API directly (devtools are repo-only):

```python
from devtools.batch import run_micro_batch

run_micro_batch(
    beta=0.2,
    gamma=0.1,
    T_end=50.0,
    dt_out=1.0,
    n_runs=10,
    out_folder="data/Simulations_Micro",
    n_communities=3,
    community_size=40,
    inter_links=2,
    seed=7,
)
```

## Visualization
Install extras for plotting:

```bash
pip install two-layer-ctmc[analysis]
```

Then use the script or the helper module:

```bash
python visualization.py
```

```python
from devtools.visualize import build_dataset_summary, plot_total_dynamics

summary = build_dataset_summary("data/Simulations_Micro")
plot_total_dynamics({"Micro": summary}, "plots/micro_summary.png")
```

## Developer scripts
These scripts are for developer convenience and use `config.json`:

```bash
python Micro_simulator.py
python micromacro2.py
python visualization.py
```

## Engine-only module usage
Use the engine module directly without CSV output or plotting:

```python
from two_layer_ctmc import MicroEngine, MicroSimulator, MicroMacroSimulator, Orchestrator
```

## Configure runs
Edit `config.json` to set:
- `network`: communities (`communities`), nodes per community (`community_size`), inter links (`inter_links`), macro topology (`macro_graph_type`), micro topology (`micro_graph_type`), random edge probability (`edge_prob`), and RNG seed.
- `virus`: infection `beta`, recovery `gamma`, and `model` (`1` = SIS, `2` = SIR).
- `simulation`: number of runs, base seed offset, and horizon `T_end`.
- Variant-specific output folders and step sizes (`micro.dt_out`, `micro.out_folder`, `micro.plots_first_infection`, `micro.plots_all_communities`, `micromacro.tau_micro`, `micromacro.macro_T`, etc.).
- Paths in `config.json` are resolved relative to the repo and accept either `/` or `\\` separators.

## Run simulators
These repo-level scripts write per-run CSVs with columns `community,time,S,I,R` to the folder configured in `config.json`, and optionally log metadata if `sim_db.py` is available.

```bash
python Micro_simulator.py   # Full microscopic baseline
python micromacro2.py       # Micro/Macro v2 (optimized)
```

## Visualize results
`visualization.py` reads configured folders, interpolates curves onto a common grid, selects a representative run per variant, and exports plots to `plots/`.

```bash
python visualization.py
```

## Data and logging
- CSV layout: one file per run; rows are uniform time samples (`t=0, dt, 2dt, …, T_end`) for every community.
- Run metadata (simulator name, version, params, output folder, runtime if provided) can be stored in `simulations.db`; see `sim_db.list_runs()` for inspection.

## Reproducibility tips
- Use `base_seed` in `config.json` to keep runs reproducible; seeds auto-increment per run.
- Switch between SIR/SIS via `virus.model`.
- Keep `data/` and `plots/` under version control ignore lists if outputs are large (already covered by `.gitignore`).
